services:
  blogengine:
    image: ghcr.io/while-maybe/blogengine:latest
    container_name: blogengine
    restart: unless-stopped
    environment:
      - APP_NAME=${APP_NAME:-"give me a name :("}
      - APP_ENV=prod
      - APP_SOURCES_DIR=${APP_SOURCES_DIR:-./sources}

      - HTTP_PORT=${HTTP_PORT:-3000}
      
      - LIMITER_RPS=${LIMITER_RPS:-20}
      - LIMITER_BURST=${LIMITER_BURST:-50}
      
      - PROXY_TRUSTED=${PROXY_TRUSTED:-true}

      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-jaeger:4318}
      - ENABLE_TELEMETRY=${ENABLE_TELEMETRY:-true}

    volumes:
      - "${APP_SOURCES_DIR:-./sources}:/app/sources"
    networks:
      - blogengine_network


  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    depends_on:
      - blogengine
    networks:
      - blogengine_network

  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    restart: unless-stopped
    profiles: ["obs"]
    networks:
      - blogengine_network

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    profiles: ["obs"]
    volumes:
      - prometheus_data:/prometheus
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    networks:
      - blogengine_network

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    profiles: ["obs"]
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/etc/grafana/provisioning/dashboards/blogengine.json

      - GF_AUTH_ANONYMOUS_HIDE_VERSION=true  # Hides version number in footer
      - GF_EXPLORE_ENABLED=false
      - GF_ALERTING_ENABLED=false
      - GF_UNIFIED_ALERTING_ENABLED=false
      - GF_NEWS_NEWS_FEED_ENABLED=false
      - GF_HELP_ENABLED=false

    volumes:
      - grafana_data:/var/lib/grafana
      - ./observability/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./observability/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    depends_on:
      - prometheus
    networks:
      - blogengine_network

  updater:
    image: docker:cli
    container_name: gitops_updater
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/app
    working_dir: /app
    environment:
      - APP_NAME=${APP_NAME:-"give me a name :("}
      - COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME}

    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        apk add --no-cache git
        git config --global --add safe.directory /app

        TARGET_IMAGE="ghcr.io/while-maybe/blogengine:latest"
        
        echo "GitOps Updater starting for: $$APP_NAME"

        while true; do
          NEEDS_UPDATE=0
          
          # check git (config)
          git fetch origin 2>&1
          LOCAL=$$(git rev-parse HEAD 2>/dev/null || echo "")
          REMOTE=$$(git rev-parse @{u} 2>/dev/null || echo "")
          
          if [ -n "$$LOCAL" ] && [ -n "$$REMOTE" ] && [ "$$LOCAL" != "$$REMOTE" ]; then
            echo "Configuration changes detected. Pulling..."
            git pull
            NEEDS_UPDATE=1
          fi

          # grab the sha image ID before pull
          OLD_ID=$$(docker inspect --format='{{.Id}}' $$TARGET_IMAGE 2>/dev/null || echo "none")
          docker compose -f docker-compose.production.yml pull --quiet blogengine tunnel
          NEW_ID=$$(docker inspect --format='{{.Id}}' $$TARGET_IMAGE 2>/dev/null || echo "none")

          # compare the IDs
          if [ "$$OLD_ID" != "$$NEW_ID" ]; then
             echo "[$$(date)] New image detected (SHA changed)."
             NEEDS_UPDATE=1
          fi

          # apply changes only if needed
          if [ "$$NEEDS_UPDATE" -eq 1 ]; then
             echo "[$$(date)] Applying updates for $$APP_NAME..."
             docker compose -f docker-compose.production.yml up -d --remove-orphans blogengine tunnel
             echo "[$$(date)] Update complete."
          else
             echo "System up to date."
          fi

          sleep 300
        done
    
    networks:
      - blogengine_network


volumes:
  prometheus_data:
  grafana_data:

networks:
  blogengine_network:
    name: blogengine_network
