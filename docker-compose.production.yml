services:
  blog:
    image: ghcr.io/while-maybe/blogengine:latest
    container_name: blogengine
    restart: unless-stopped
    environment:
      - APP_NAME=${APP_NAME:-"give me a name :("}
      - APP_ENV=prod
      - APP_SOURCES_DIR=${APP_SOURCES_DIR:-./sources}
      - HTTP_PORT=${HTTP_PORT:-3000}
      - LIMITER_RPS=${LIMITER_RPS:-20}
      - LIMITER_BURST=${LIMITER_BURST:-50}
      - PROXY_TRUSTED=${PROXY_TRUSTED:-true}
    networks:
      - blog_net

  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    depends_on:
      - blog
    networks:
      - blog_net

  updater:
    image: docker:cli
    container_name: gitops_updater
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/app
    working_dir: /app
    environment:
      # will be set in the shell from the current directory
      - COMPOSE_PROJECT_NAME=
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        apk add --no-cache git
        git config --global --add safe.directory /app

        # derive project name from current directory
        PROJECT_NAME=$$(basename "$$(pwd)")
        export COMPOSE_PROJECT_NAME="$$PROJECT_NAME"
        echo "COMPOSE_PROJECT_NAME set to $$PROJECT_NAME"

        TARGET_IMAGE="ghcr.io/while-maybe/blogengine:latest"
        
        echo "GitOps Updater starting in project $$PROJECT_NAME..."

        while true; do
          NEEDS_UPDATE=0
          echo "[$$(date)] Checking for updates..."
          
          # check git (config)
          git fetch origin 2>&1
          LOCAL=$$(git rev-parse HEAD 2>/dev/null || echo "")
          REMOTE=$$(git rev-parse @{u} 2>/dev/null || echo "")
          
          if [ -n "$$LOCAL" ] && [ -n "$$REMOTE" ] && [ "$$LOCAL" != "$$REMOTE" ]; then
            echo "Configuration changes detected. Pulling..."
            git pull
            NEEDS_UPDATE=1
          fi

          # grab the sha image ID before pull
          OLD_ID=$$(docker inspect --format='{{.Id}}' $$TARGET_IMAGE 2>/dev/null || echo "none")
          docker compose -f docker-compose.production.yml pull --quiet blog tunnel
          NEW_ID=$$(docker inspect --format='{{.Id}}' $$TARGET_IMAGE 2>/dev/null || echo "none")

          # compare the IDs
          if [ "$$OLD_ID" != "$$NEW_ID" ]; then
             echo "[$$(date)] New image detected (SHA changed)."
             NEEDS_UPDATE=1
          fi

          # apply changes only if needed
          if [ "$$NEEDS_UPDATE" -eq 1 ]; then
             
             echo "[$$(date)] Applying updates for project $$PROJECT_NAME..."
             
             # --remove-orphans cleans up old containers if removed from YAML
             docker compose -f docker-compose.production.yml up -d --remove-orphans blog tunnel
             echo "[$$(date)] Update complete."
          else
             echo "System up to date."
          fi

          sleep 300
        done
    
    networks:
      - blog_net

networks:
  blog_net:
    name: blog_production_network