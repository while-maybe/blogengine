services:
  updater:
    image: docker:cli
    container_name: gitops_updater
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/app
    working_dir: /app
    environment:
      - APP_NAME=${APP_NAME:-"Strange Coding Blog"}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        apk add --no-cache git
        git config --global --add safe.directory /app
        
        log() {
            echo "[$$(date '+%Y-%m-%d %H:%M:%S')] $$1"
        }

        TARGET_IMAGE="ghcr.io/while-maybe/blogengine:latest"
        
        log "GitOps Manager starting for: $$APP_NAME"
        
        while true; do
          NEEDS_UPDATE=0
          
          git fetch origin main 2>&1 >/dev/null
          
          LOCAL=$(git rev-parse HEAD)
          REMOTE=$(git rev-parse origin/main)
          
          if [ "$$LOCAL" != "$$REMOTE" ]; then
            log "Configuration change detected (Git)."
            log "Local:  $$LOCAL"
            log "Remote: $$REMOTE"

            git reset --hard origin/main
            
            # remove untracked files/folders
            git clean -fd
            
            NEEDS_UPDATE=1
          fi

          OLD_ID=$(docker inspect --format='{{.Id}}' $$TARGET_IMAGE 2>/dev/null || echo "none")
          docker compose -f docker-compose.production.yml pull --quiet
          NEW_ID=$(docker inspect --format='{{.Id}}' $$TARGET_IMAGE 2>/dev/null || echo "none")

          if [ "$$OLD_ID" != "$$NEW_ID" ]; then
             log "New application image detected (SHA changed)."
             NEEDS_UPDATE=1
          fi

          # 4. Apply Updates
          if [ "$$NEEDS_UPDATE" -eq 1 ]; then
             log "Updating Production Stack..."
             docker compose -f docker-compose.production.yml up -d --remove-orphans
             log "Update complete."
          fi

          sleep 300
        done